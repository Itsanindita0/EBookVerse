{
  "entities": {
    "User": {
      "$schema": "http://json-schema.org/draft-07/schema#",
      "title": "User",
      "type": "object",
      "description": "Represents a user of the EBookVerse application.",
      "properties": {
        "id": {
          "type": "string",
          "description": "Unique identifier for the user entity."
        },
        "firebaseUid": {
          "type": "string",
          "description": "The Firebase Authentication UID associated with the user."
        },
        "email": {
          "type": "string",
          "description": "The user's email address.",
          "format": "email"
        },
        "displayName": {
          "type": "string",
          "description": "The user's display name."
        },
        "photoURL": {
          "type": "string",
          "description": "URL of the user's profile photo.",
          "format": "uri"
        },
        "role": {
          "type": "string",
          "description": "The user's role (e.g., 'user', 'admin')."
        },
        "library": {
          "type": "array",
          "description": "References to Ebooks the user has purchased. (Relationship: User 1:N Ebook)",
          "items": {
            "type": "string"
          }
        },
        "createdAt": {
          "type": "string",
          "description": "Timestamp indicating when the user was created.",
          "format": "date-time"
        },
        "updatedAt": {
          "type": "string",
          "description": "Timestamp indicating when the user was last updated.",
          "format": "date-time"
        }
      },
      "required": [
        "id",
        "firebaseUid",
        "email",
        "displayName"
      ]
    },
    "Ebook": {
      "$schema": "http://json-schema.org/draft-07/schema#",
      "title": "Ebook",
      "type": "object",
      "description": "Represents an e-book in the EBookVerse application.",
      "properties": {
        "id": {
          "type": "string",
          "description": "Unique identifier for the ebook entity."
        },
        "title": {
          "type": "string",
          "description": "The title of the e-book."
        },
        "author": {
          "type": "string",
          "description": "The author of the e-book."
        },
        "description": {
          "type": "string",
          "description": "A description of the e-book."
        },
        "genre": {
          "type": "string",
          "description": "The genre of the e-book."
        },
        "publishYear": {
          "type": "number",
          "description": "The year the e-book was published."
        },
        "price": {
          "type": "number",
          "description": "The price of the e-book."
        },
        "coverImageURL": {
          "type": "string",
          "description": "URL of the e-book's cover image.",
          "format": "uri"
        },
        "fileURL": {
          "type": "string",
          "description": "URL of the e-book file.",
          "format": "uri"
        },
        "uploadedBy": {
          "type": "string",
          "description": "Reference to User who uploaded the book. (Relationship: User 1:N Ebook)"
        },
        "createdAt": {
          "type": "string",
          "description": "Timestamp indicating when the e-book was created.",
          "format": "date-time"
        },
        "updatedAt": {
          "type": "string",
          "description": "Timestamp indicating when the e-book was last updated.",
          "format": "date-time"
        }
      },
      "required": [
        "id",
        "title",
        "author",
        "description",
        "genre",
        "coverImageURL",
        "fileURL",
        "price"
      ]
    },
    "CartItem": {
      "$schema": "http://json-schema.org/draft-07/schema#",
      "title": "CartItem",
      "type": "object",
      "description": "Represents an item in a user's shopping cart.",
      "properties": {
        "ebookId": {
          "type": "string",
          "description": "Reference to Ebook. (Relationship: Ebook 1:1 CartItem)"
        },
        "quantity": {
          "type": "number",
          "description": "The quantity of the ebook in the cart."
        },
        "addedAt": {
          "type": "string",
          "description": "Timestamp indicating when the item was added to the cart.",
          "format": "date-time"
        }
      },
      "required": ["ebookId", "quantity"]
    },
    "Review": {
      "$schema": "http://json-schema.org/draft-07/schema#",
      "title": "Review",
      "type": "object",
      "description": "Represents a user's review of an e-book.",
      "properties": {
        "id": {
          "type": "string",
          "description": "Unique identifier for the review entity."
        },
        "userId": {
          "type": "string",
          "description": "Reference to User who created the review. (Relationship: User 1:N Review)"
        },
        "ebookId": {
          "type": "string",
          "description": "Reference to Ebook being reviewed. (Relationship: Ebook 1:N Review)"
        },
        "rating": {
          "type": "number",
          "description": "The user's rating of the e-book (1-5)."
        },
        "reviewText": {
          "type": "string",
          "description": "The user's review text."
        },
        "createdAt": {
          "type": "string",
          "description": "Timestamp indicating when the review was created.",
          "format": "date-time"
        },
        "updatedAt": {
          "type": "string",
          "description": "Timestamp indicating when the review was last updated.",
          "format": "date-time"
        }
      },
      "required": [
        "id",
        "userId",
        "ebookId",
        "rating"
      ]
    }
  },
  "auth": {
    "providers": [
      "password",
      "anonymous"
    ]
  },
  "firestore": {
    "structure": [
      {
        "path": "/users/{userId}",
        "definition": {
          "entityName": "User",
          "schema": {
            "$ref": "#/backend/entities/User"
          },
          "description": "Stores user profiles.  firebaseUid must match {userId}.",
          "params": [
            {
              "name": "userId",
              "description": "The Firebase Authentication UID associated with the user."
            }
          ]
        }
      },
      {
        "path": "/ebooks/{ebookId}",
        "definition": {
          "entityName": "Ebook",
          "schema": {
            "$ref": "#/backend/entities/Ebook"
          },
          "description": "Stores e-book metadata.",
          "params": [
            {
              "name": "ebookId",
              "description": "Unique identifier for the ebook entity."
            }
          ]
        }
      },
      {
        "path": "/users/{userId}/library/{ebookId}",
        "definition": {
          "entityName": "Ebook",
          "schema": {
            "$ref": "#/backend/entities/Ebook"
          },
          "description": "Represents the many-to-many relationship between users and e-books (a user's purchased books).",
          "params": [
            {
              "name": "userId",
              "description": "The Firebase Authentication UID associated with the user."
            },
            {
              "name": "ebookId",
              "description": "Unique identifier for the ebook entity."
            }
          ]
        }
      },
      {
        "path": "/users/{userId}/cart/{ebookId}",
        "definition": {
          "entityName": "CartItem",
          "schema": {
            "$ref": "#/backend/entities/CartItem"
          },
          "description": "Stores the user's shopping cart items.",
          "params": [
            {
              "name": "userId",
              "description": "The Firebase Authentication UID associated with the user."
            },
            {
              "name": "ebookId",
              "description": "Unique identifier for the ebook entity, used as the document ID for the cart item."
            }
          ]
        }
      },
      {
        "path": "/ebooks/{ebookId}/reviews/{reviewId}",
        "definition": {
          "entityName": "Review",
          "schema": {
            "$ref": "#/backend/entities/Review"
          },
          "description": "Reviews are stored as a subcollection of the `/ebooks/{ebookId}` document.",
          "params": [
            {
              "name": "ebookId",
              "description": "Unique identifier for the ebook entity."
            },
            {
              "name": "reviewId",
              "description": "Unique identifier for the review entity."
            }
          ]
        }
      }
    ],
    "reasoning": "The Firestore data structure is designed to support the EBookVerse application, prioritizing security, scalability, and debuggability as per the core design principles. Authorization Independence is achieved through path-based ownership for user-specific data and denormalization where necessary. DBAC is enforced by relying solely on `request.auth.uid` for authorization. Rules are designed to avoid being filters by leveraging structural segregation.\n\n1.  **Users Collection (`/users/{userId}`):** Stores user profiles. User data is directly accessible only to the authenticated user. Profile information is kept here.\n2.  **Ebooks Collection (`/ebooks/{ebookId}`):** Stores e-book metadata. This collection contains general information about each e-book. No user-specific data resides here.\n3.  **User Libraries (`/users/{userId}/library/{ebookId}`):** Represents the many-to-many relationship between users and e-books (a user's library of purchased books). This subcollection stores only references to ebooks in the main `/ebooks` collection. This approach avoids duplicating ebook data and keeps user-specific library information separate. `ebookId` serves as the document ID.\n4.  **User Cart (`/users/{userId}/cart/{ebookId}`):** This subcollection holds the items in a user's shopping cart. Nesting it under the user simplifies security rules, ensuring only the user can access their own cart.\n5.  **Reviews (`/ebooks/{ebookId}/reviews/{reviewId}`):** Reviews are stored as a subcollection of the `/ebooks/{ebookId}` document. This allows easy querying for reviews associated with a particular e-book. The review also contains the `userId` for identifying the reviewer and can be used for security rules if needed."
  }
}
